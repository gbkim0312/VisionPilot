cmake_minimum_required(VERSION 3.20)
project(vp)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

if(NOT CMAKE_BINARY_DIR)
    set(CMAKE_BINARY_DIR "${PROJECT_ROOT_DIR}/build/debug/vision_pilot" CACHE PATH "Build directory" FORCE)
endif()

# --- ê²½ë¡œ ì„¤ì • (ë§ˆìŠ¤í„° ìŠ¤í¬ë¦½íŠ¸ì™€ ë™ê¸°í™”) ---
if(NOT CMAKE_INSTALL_PREFIX OR CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)
    # ë³„ë„ ì¸ìê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ì²˜ëŸ¼ build/testë¥¼ ì“°ì§€ë§Œ, ë§ˆìŠ¤í„° ìŠ¤í¬ë¦½íŠ¸ í˜¸ì¶œ ì‹œì—ëŠ” ë¬´ì‹œë¨
    set(CMAKE_INSTALL_PREFIX "${PROJECT_ROOT_DIR}/build/debug/install" CACHE PATH "..." FORCE)
endif()

if(NOT ACV2X_TOOLCHAIN_NAME)
    set(ACV2X_TOOLCHAIN_NAME "x86-64" CACHE STRING "Toolchain name" FORCE)
endif()

if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE "Debug" CACHE STRING "Build type" FORCE)
endif()

if(NOT OpenCV_DIR)
    set(OpenCV_DIR "${PROJECT_ROOT_DIR}/${CMAKE_INSTALL_PREFIX}/lib/cmake/opencv4" CACHE PATH "OpenCV cmake path" FORCE)
endif()

if(NOT PROJECT_ROOT_DIR)
    set(PROJECT_ROOT_DIR "${CMAKE_CURRENT_SOURCE_DIR}/.." CACHE PATH "Project root directory" FORCE)
endif()

if(NOT stella_vslam_DIR)
    set(stella_vslam_DIR "${PROJECT_ROOT_DIR}/${CMAKE_INSTALL_PREFIX}/lib/cmake/stella_vslam" CACHE PATH "Stella-VSLAM cmake path" FORCE)
endif()

message(STATUS "ğŸš© CMAKE_INSTALL_PREFIX: ${CMAKE_INSTALL_PREFIX}")
message(STATUS "ğŸš© ACV2X_TOOLCHAIN_NAME: ${ACV2X_TOOLCHAIN_NAME}")
message(STATUS "ğŸš© CMAKE_BUILD_TYPE: ${CMAKE_BUILD_TYPE}")
message(STATUS "ğŸš© OpenCV_DIR: ${OpenCV_DIR}")
message(STATUS "ğŸš© stella_vslam_DIR: ${stella_vslam_DIR}")

# ê¸°ë³¸ ì¶œë ¥ ê²½ë¡œ
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# CCache ì„¤ì •
find_program(CCACHE_PROGRAM ccache)
if(CCACHE_PROGRAM)
    set_property(GLOBAL PROPERTY RULE_LAUNCH_COMPILE "${CCACHE_PROGRAM}")
endif()

find_program(CLANG_TIDY_EXE NAMES "clang-tidy-18" "clang-tidy")
if(NOT CLANG_TIDY_EXE)
    message(FATAL_ERROR "clang-tidy not found! Static analysis will be skipped."  )
endif()

find_program(CLANG_EXE NAMES "clang-18" "clang")
if(NOT CLANG_EXE)
    message(FATAL_ERROR "clang compiler not found! Static analysis will be skipped.")
endif()


# --- ì •ì  ë¶„ì„ ì„¤ì • ---
include(FetchContent)
list(APPEND CMAKE_MODULE_PATH "${PROJECT_ROOT_DIR}/cmake")
include(ClangTidyFlags)

# --- 1. nlohmann_json (Header Only) ---
find_package(nlohmann_json CONFIG QUIET)
if(NOT TARGET nlohmann_json::nlohmann_json)
    FetchContent_Declare(nlohmann_json GIT_REPOSITORY https://github.com/nlohmann/json.git GIT_TAG v3.11.3)
    FetchContent_MakeAvailable(nlohmann_json)
endif()

# --- 2. OpenCV (ëª¨ë…¸ë ˆí¬ install ë””ë ‰í† ë¦¬ ì°¸ì¡°) ---
# ë§ˆìŠ¤í„° ìŠ¤í¬ë¦½íŠ¸ì—ì„œ -DCMAKE_PREFIX_PATH ë˜ëŠ” -DOpenCV_DIRë¡œ ê²½ë¡œë¥¼ ë„˜ê²¨ì¤Œ
find_package(OpenCV REQUIRED COMPONENTS core imgproc videoio dnn imgcodecs objdetect highgui features2d calib3d)
message(STATUS "âœ… Found OpenCV: ${OpenCV_VERSION} at ${OpenCV_DIR}")

# --- 3. Stella-VSLAM (ëª¨ë…¸ë ˆí¬ install ë””ë ‰í† ë¦¬ ì°¸ì¡°) ---
# stella_vslam_DIRì€ ë§ˆìŠ¤í„° ìŠ¤í¬ë¦½íŠ¸ì˜ ./build.sh í˜¸ì¶œ ì‹œ ì „ë‹¬ë¨
find_package(stella_vslam REQUIRED)
message(STATUS "âœ… Found Stella-VSLAM at ${stella_vslam_DIR}")

# --- 4. ê¸°íƒ€ ì˜ì¡´ì„± (gtest, gbench) ---
FetchContent_Declare(googletest GIT_REPOSITORY https://github.com/google/googletest.git GIT_TAG v1.15.2)
FetchContent_MakeAvailable(googletest)

FetchContent_Declare(googlebenchmark GIT_REPOSITORY https://github.com/google/benchmark GIT_TAG v1.5.3)
FetchContent_MakeAvailable(googlebenchmark)

# --- í•˜ìœ„ ë””ë ‰í† ë¦¬ ì¶”ê°€ ---
add_subdirectory(gaia)
add_subdirectory_with_static_analysis(config)
add_subdirectory_with_static_analysis(infrastructure)
add_subdirectory_with_static_analysis(adapter)
add_subdirectory_with_static_analysis(application)
add_subdirectory_with_static_analysis(assembly)

# --- íƒ€ê²Ÿ ìƒì„± ë° ë§í¬ ---
add_executable(${PROJECT_NAME} main.cpp)

target_link_libraries(${PROJECT_NAME}
    PRIVATE
        vp::assembly
        vp::config
        ${OpenCV_LIBS}
        stella_vslam::stella_vslam  # ìŠ¤í…”ë¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ íƒ€ê²Ÿ ëª…ì¹­ í™•ì¸ í•„ìš”
)

target_include_directories(${PROJECT_NAME} PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/assembly/include
)

# 1. ë©”ì¸ ì‹¤í–‰ íŒŒì¼ ì„¤ì¹˜
install(TARGETS ${PROJECT_NAME}
    RUNTIME DESTINATION bin
    COMPONENT vp_executables
)

# 2. ì§ì ‘ ë§Œë“  ì„œë¸Œ ëª¨ë“ˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ ì„¤ì¹˜ (vp::config, vp::adapter ë“±)
# í•˜ìœ„ CMakeLists.txtì—ì„œ ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ íƒ€ê²Ÿ ì´ë¦„ìœ¼ë¡œ ëª¨ì•„ì„œ ì„¤ì¹˜ ê°€ëŠ¥
install(TARGETS config event vp_frame_loader port_in port_out assembly gaia adapter_vslam
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib
    COMPONENT vp_libraries
)

# 3. FetchContentë¡œ ë¹Œë“œëœ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ ì„¤ì¹˜
# spdlog, gtest, benchmark ë“±ì€ ê° í”„ë¡œì íŠ¸ì—ì„œ ì •ì˜í•œ íƒ€ê²Ÿ ì´ë¦„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
install(TARGETS spdlog gtest gtest_main gmock benchmark benchmark_main
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib
    COMPONENT vp_dependencies
)

# 4. ë¦¬ì†ŒìŠ¤ íŒŒì¼ ì„¤ì¹˜
install(FILES res/etc/sample.mp4
    DESTINATION etc
    COMPONENT vp_samples
)